<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Request Logs</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, lch(30.07% 0.44 199.94), #00f2fe);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      text-align: center;
      color: #d6cbcb;
      margin-top: 20px;
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }

    button {
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }

    button.active {
      background: #007bff;
      color: white;
    }

    button:hover {
      background: #0056b3;
      color: white;
    }

    .logs-container {
      width: 90%;
      max-width: 900px;
      background: #d7e3e2;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 40px;
      overflow-y: auto;
      max-height: 75vh;
    }

    .log-item {
      border-bottom: 1px solid #e0e0e0;
      padding: 12px 8px;
    }

    .log-item:last-child {
      border-bottom: none;
    }

    .log-item h4 {
      margin: 0 0 6px 0;
      color: #007bff;
    }

    .log-item p {
      margin: 4px 0;
      font-size: 14px;
      color: #555;
    }

    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: bold;
      text-transform: capitalize;
    }

    .status.resolved {
      background: #d4edda;
      color: #155724;
    }
    .status.rejected {
      background: #f8d7da;
      color: #721c24;
    }
    .status.failed {
      background: #ffeeba;
      color: #856404;
    }
    /* .status["in process"], */
    .status.in-process {
      background: #cce5ff;
      color: #004085;
    }

    .refresh {
      background: #28a745;
      color: white;
    }

    .refresh:hover {
      background: #218838;
    }

    .back-btn {
      position: absolute;
      left: 20px;
      top: 20px;
      padding: 8px 14px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .back-btn:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>

  <button class="back-btn" onclick="window.location.href='dashboard.html'">← Back to Dashboard</button>

  <h2>Request Logs</h2>

  <div class="buttons">
    <button id="btn-approval" class="active">Approval Requests</button>
    <button id="btn-claim">Claim Requests</button>
    <button id="btn-refresh" class="refresh">Refresh</button>
  </div>

  <div class="logs-container" id="logsContainer">
    <p style="text-align:center; color:#777;">Loading logs...</p>
  </div>

  <script>
    // --- Utility to read cookies ---
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const logsContainer = document.getElementById("logsContainer");
      const btnApproval = document.getElementById("btn-approval");
      const btnClaim = document.getElementById("btn-claim");
      const btnRefresh = document.getElementById("btn-refresh");

      let allLogs = { approval: [], claim: [] };
      let currentView = "approval";

      // Fetch logs from API
      async function fetchLogs() {
        const user_id = getCookie("user_id");
        if (!user_id) {
          logsContainer.innerHTML = `<p style='color:red; text-align:center;'>User not logged in. Please log in first.</p>`;
          return;
        }

        logsContainer.innerHTML = "<p style='text-align:center; color:#777;'>Fetching latest logs...</p>";

        try {
          const response = await fetch("https://backend-workflow.vercel.app/fetch_request_logs", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-user-id": user_id
            }
          });

          if (!response.ok) throw new Error("Failed to fetch logs");
          allLogs = await response.json();
          renderLogs(currentView);

        } catch (err) {
          logsContainer.innerHTML = `<p style='color:red; text-align:center;'>Error: ${err.message}</p>`;
          console.error("❌ Fetch error:", err);
        }
      }

      // Render logs based on type
      function renderLogs(type) {
        currentView = type;
        logsContainer.innerHTML = "";

        const logs = allLogs[type];
        if (!logs || logs.length === 0) {
          logsContainer.innerHTML = `<p style='text-align:center; color:#777;'>No ${type} logs found.</p>`;
          return;
        }

        logs.forEach(log => {
          const div = document.createElement("div");
          div.className = "log-item";

          let content = `<h4>Request ID: ${log.req_id}</h4>`;

          if (type === "claim") {
            content += `
              <p><b>Policy Number:</b> ${log.policy_number}</p>
              <p><b>Invoice #:</b> ${log.invoice_number}</p>
              <p><b>Claim ID:</b> ${log.claim_id}</p>
              <p><b>Service Type:</b> ${log.service_type}</p>
              <p><b>Total Bill:</b> ${log.total_bill}</p>
              <p><b>Status:</b> <span class="status ${log.status.replace(' ', '-')}">${log.status}</span></p>
              <p><b>Remarks:</b> ${log.remarks ?? "—"}</p>
              <p><small><b>Created:</b> ${new Date(log.created_at).toLocaleString()}</small></p>
            `;
          } else {
            content += `
              <p><b>Policy Number:</b> ${log.policy_number}</p>
              <p><b>Policy Holder:</b> ${log.policy_holder_name}</p>
              <p><b>Requested Amount:</b> ${log.req_amount}</p>
              <p><b>Status:</b> <span class="status ${log.status.replace(' ', '-')}">${log.status}</span></p>
              <p><b>Remarks:</b> ${log.remarks ?? "—"}</p>
              <p><small><b>Created:</b> ${new Date(log.created_at).toLocaleString()}</small></p>
            `;
          }

          div.innerHTML = content;
          logsContainer.appendChild(div);
        });
      }

      // Event listeners
      btnApproval.addEventListener("click", () => {
        btnApproval.classList.add("active");
        btnClaim.classList.remove("active");
        renderLogs("approval");
      });

      btnClaim.addEventListener("click", () => {
        btnClaim.classList.add("active");
        btnApproval.classList.remove("active");
        renderLogs("claim");
      });

      btnRefresh.addEventListener("click", () => {
        fetchLogs();
      });

      // Initial fetch
      fetchLogs();
    });
  </script>
</body>
</html>

